# JavaScript compiled to WebAssembly

This project is using
[the SpiderMonkey JavScript engine compiled to WebAssembly](https://github.com/tschneidereit/spidermonkey-wasi-embedding)
in order to execute JavaScript scripts on WASI runtimes.

The goal is to use the HTTP and other Glass triggers from the parent repository
and write handlers for them in JavaScript.

### Using the JavaScript engine

Note that currently, support for this is limited to only reading the request
method and body, and returning the status code.

```js
async function handler(req, res) {
  console.log("Value of body: " + new TextDecoder().decode(req.body));
  console.log("Value of method: " + req.method);

  res.status = 418;
}
```

First, build a pre-initialized module by running `make runtime.wasm`. Then,
start the module using the Glass HTTP runtime:

```
➜ curl -i localhost:3000 --data "Handling Glass HTTP requests in JS"
HTTP/1.1 418 I'm a teapot
content-length: 0

➜ ./target/release/glass http --local crates/js-runtime/initialized.wasm
Value of body: Handling Glass HTTP requests in JS
Value of method: POST
The answer to life, the universe, and everything: 42
INFO  glass_runtime_http::runtime] Result status code: 418
INFO  glass_runtime_http::runtime] Total request execution time: 26.9954ms
```

### Building

Building the JavaScript runtime is currently only tested on Linux.

Requirements:

- Make
- [WASI SDK](https://github.com/WebAssembly/wasi-sdk) present in `/opt/wasi-sdk`
  (configurable in `Makefile`)
- [`wizer`](https://github.com/bytecodealliance/wizer)
- [`witx-bindgen`](https://github.com/bytecodealliance/witx-bindgen/)

After the prerequisites have been acquired, building the runtime can be done
using the following Make targets:

```shell
➜ make bootstrap
➜ make bindgen
➜ make runtime.wasm
```

- `make bootstrap` -- this downloads the SpiderMonkey engine pre-compiled to
  WebAssembly, and only has to be executed once.
- `make bindgen` -- this generates the C bindings for the underlying interfaces
  that have to be implemented, and has to be executed whenever any interface
  changes. (As more interfaces are added, their bindings should also be
  generated by this target.)
- `make runtime.wasm` -- this builds the main component that contains the
  component, and also generates a module already pre-initialized with the JS
  source code from `index.js`, `initialized.wasm`.

Testing the pre-initialized module with the Glass CLI:

```
➜ ./target/release/glass http --local crates/js-runtime/initialized.wasm
```
